---
title: SE(3) 等变的生成扩散模型
date: 2024-04-20
---

在蛋白质结构生成中遇到的一篇数学很硬的文献，为了后续的研究需要，学习一下SE(3)等变的生成扩散模型。

## 1 扩散模型初步

之前组会报告准备过一次关于一般扩散模型的内容[扩散模型简介](./扩散模型简介.pdf)，但是模型不具有SE(3)等变性质。

## 2 什么是 SE(3)？为什么需要SE(3)？
###   2.1. SE(3) 的定义  

SE(3)（Special Euclidean group in 3D，即三维特殊欧几里得群），它包括旋转和平移两部分。数学上，SE(3) 定义为：

\[
SE(3) = \{(R, x) \mid R \in SO(3), x \in \mathbb{R}^3\}
\]

其中：
- \( R \in SO(3) \) 是一个 \( 3 \times 3 \) 正交矩阵（即 \( R^\top R = I \)）且 \(\det(R) = 1\)，表示三维旋转。
- \( x \in \mathbb{R}^3 \) 是一个三维平移向量，表示刚体在三维空间的平移。

SE(3) 的群运算是：

\[
(R_1, x_1) \cdot (R_2, x_2) = (R_1 R_2, R_1 x_2 + x_1)
\]

它表示一个刚体变换 \( (R_2, x_2) \) 作用后，再应用变换 \( (R_1, x_1) \) 的结果。

###   2.2. 为什么需要 SE(3)？  

涉及三维刚体的问题中，特别是在分子模拟、机器人学、计算机视觉等领域，物体的状态不仅仅是一个位置（平移），还包括方向（旋转）。SE(3) 提供了一个数学框架，使得我们可以在同一个空间中处理这些信息。
 
在 SE(3) 空间上进行建模的一个关键优势是，它能够保持物理和几何的不变性。具体来说：
- 在蛋白质建模中，蛋白质的结构和功能通常仅取决于其相对构象，而不是其绝对位置或方向。因此，我们希望构造的模型具有对称性，不会因坐标选取不同而导致结果不同。
- 在机器人学中，机器人手臂、自动驾驶汽车、无人机的姿态（pose）通常在 SE(3) 上进行建模，以便在不同的参考系之间转换。
- 在计算机视觉中，物体识别和跟踪通常需要对旋转和平移具有鲁棒性，因此 SE(3) 变换在 3D 目标检测和姿态估计任务中十分重要。
### 2.3. 蛋白质中的 SE(3) 是什么？ 
在蛋白质结构建模中，平移通常指的是 Cα 的平移 ，而旋转则涉及整个框架（frame）的旋转。

每个氨基酸残基由一组固定的主链原子（N、Cα、C、O）组成，这些原子在理想化情况下保持相对固定的几何关系。旋转的核心是这个刚性框架（frame）的方向，即以 Cα 作为中心的旋转。

蛋白质的主链是通过共价键连接的，每个残基的 N、Cα、C 具有固定的几何关系（键长、键角）。因此，在建模过程中，我们可以将每个残基视为一个刚体，即只允许其进行整体的刚体旋转，而不改变内部键长和键角。

数学上，我们用一个  SE(3) 变换  \( T = (R, x) \) 来表示残基的空间位姿：
-  \( x \in \mathbb{R}^3 \) ：表示 Cα 的平移位置（即氨基酸的中心位置）。
-  \( R \in SO(3) \) ：表示该残基在三维空间中的 方向 ，即 N、Cα、C 三个原子构成的刚体的旋转。

由于 SE(3) 变换是作用在刚体上的，我们需要一个合适的坐标系来描述残基的方向。通常，我们使用Gram-Schmidt 正交化来构造一个正交基，以描述 N、Cα、C 的相对方向，从而定义\(R\)。

如果我们用 \( T_n = (R_n, x_n) \) 表示第 \( n \) 个残基的 pose，那么：
\[
[N_n, C_n, (Cα)_n] = T_n \cdot [N^*, C^*, Cα^*],
\]
其中：\( [N^*, C^*, Cα^*] \) 是理想化残基的标准坐标。\( T_n = (R_n, x_n) \) 作用在这些坐标上，给出第 \( n \) 个残基在三维空间中的实际位置。


## 3. SE(3) 扩散模型
### 3.1. SE(3) 扩散模型的基本思想
 

为了在 SE(3) 上进行扩散建模，我们需要定义 SE(3) 上的随机过程。然但，在 SE(3) 上直接进行扩散会带来计算上的复杂性。通过对 SE(3) 的度规进行适当的选择，我们可以证明：
\[
dT(t) = (dR(t), dX(t)),
\]
即 SE(3) 的扩散过程可以拆分成：
-   SO(3) 上的旋转扩散 \( R(t) \)  （用于建模残基刚体框架的方向）。
-   \( \mathbb{R}^3 \) 上的平移扩散 \( X(t) \)  （用于建模 Cα 原子的位置）。

这一拆分的合理性基于：
1.   SE(3) 可以用 SO(3) 和 ℝ³ 的直积表示，因此可以在两个部分分别定义扩散过程。  
2.   在适当的度规下，SE(3) 上的拉普拉斯–贝尔特拉米算子（Riemannian 流形上的 Laplace 算子）可以拆分成 SO(3) 和 ℝ³ 上的拉普拉斯算子之和  ：
   \[
   \Delta_{SE(3)} = \Delta_{SO(3)} + \Delta_{\mathbb{R}^3}.
   \]
3.   SO(3) 上的扩散可以用李群上的布朗运动建模，而 ℝ³ 上的扩散可以用经典的 Ornstein–Uhlenbeck 过程建模。  

#### 拉普拉斯–贝尔特拉米算子
在 \( \mathbb{R}^n \) 中，标准的拉普拉斯算子（Laplace Operator）定义为：
\[
\Delta f = \nabla \cdot \nabla f = \sum_{i=1}^{n} \frac{\partial^2 f}{\partial x_i^2}.
\]
它表示标量场 \( f(x) \) 的二阶导数之和，通常用于描述：

对于一个   一般的 Riemannian 流形 \( (M, g) \)  ，由于坐标系统不再是欧几里得直角坐标，我们需要用度规 \( g \) 来定义拉普拉斯算子，即拉普拉斯–贝尔特拉米算子。

\[
\Delta_M f = \text{div} (\text{grad} f).
\]
- 梯度算子（Gradient Operator）  ：
  \[
  \text{grad} f = g^{ij} \frac{\partial f}{\partial x^j} \frac{\partial}{\partial x^i}.
  \]
  其中 \( g^{ij} \) 是度规张量 \( g_{ij} \) 的逆矩阵。
- 散度算子（Divergence Operator）  ：
  \[
  \text{div} X = \frac{1}{\sqrt{|g|}} \frac{\partial}{\partial x^i} \left( \sqrt{|g|} X^i \right).
  \]
  其中 \( |g| = \det(g_{ij}) \) 是度规张量的行列式。

在局部坐标系 \( \{x^i\} \) 下，拉普拉斯–贝尔特拉米算子的显式形式为：
\[
\Delta_M f = \frac{1}{\sqrt{|g|}} \sum_{i,j} \frac{\partial}{\partial x^i} \left( \sqrt{|g|} g^{ij} \frac{\partial f}{\partial x^j} \right).
\]
这一公式在一般流形上定义了拉普拉斯算子，它依赖于流形的几何结构（即度量 \( g \)），因此在前面提到的 SE(3) 上的度规就产生了作用。

#### SE(3) 上的度规
这篇文章在 SE(3) 上选取的度量张量 \( g \) 使得 SE(3) 作为 Riemannian 流形可以分解为 \( SO(3) \) 和 \( \mathbb{R}^3 \) 的直积，并且保证旋转和平移部分的扩散过程可以独立建模。  

对于 SE(3) 上的任意两个切向量 \( (a, x), (a', x') \in \text{Tan}_T SE(3) \)，本文选取的内积定义如下：
\[
\langle (a, x), (a', x') \rangle_{SE(3)} = \langle a, a' \rangle_{SO(3)} + \langle x, x' \rangle_{\mathbb{R}^3}.
\]

其中：
-   旋转部分的度规（即 \( SO(3) \) 部分）：
  \[
  \langle a, a' \rangle_{SO(3)} = \frac{1}{2} \text{Tr}(a a'^T).
  \]
  这里 \( a, a' \in so(3) \) 是 \( SO(3) \) 李代数中的元素（即反对称矩阵）。
-   平移部分的度规  （即 \( \mathbb{R}^3 \) 部分）：
  \[
  \langle x, x' \rangle_{\mathbb{R}^3} = \sum_{i=1}^{3} x_i x'_i.
  \]
  这里 \( x, x' \in \mathbb{R}^3 \) 是标准欧几里得空间中的向量。

这种选取使得 SE(3) 在 Riemannian 意义下可视为 SO(3) 和 \( \mathbb{R}^3 \) 的直积  ，从而能够独立处理旋转和平移的扩散过程。并且拉普拉斯–贝尔特拉米算子可以分解为 \( \Delta_{SE(3)} = \Delta_{SO(3)} + \Delta_{\mathbb{R}^3} \)  ，从而扩散过程可以分别建模。旋转的 Frobenius 范数对应于经典刚体动力学中的角动量度量。平移的欧几里得度量对应于质点的物理运动。


##   2. SE(3) 扩散的基本公式  
#### 3.1.1. \( \mathbb{R}^3 \) 上的扩散

#### 3.1.2. SO(3) 上的扩散

#### 3.1.3. SE(3) 上的采样
